require("dotenv").config();
const pg = require("pg");

const pool = new pg.Pool({
  user: process.env.DB_USER,
  host: process.env.DB_HOST,
  database: process.env.DB_NAME,
  password: process.env.DB_PASSWORD,
  port: process.env.DB_PORT,
});

const createTables = async () => {
  const query = `
        CREATE TABLE IF NOT EXISTS "users" (
        "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "username" VARCHAR(100) NOT NULL,
        "password" VARCHAR(100) NOT NULL,
        "email" VARCHAR(60) NOT NULL
        );

        CREATE TABLE IF NOT EXISTS "user_roles" (
        "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "user_id" INT NOT NULL,
        "role_id" INT NOT NULL
        );

        CREATE TABLE IF NOT EXISTS "roles" (
        "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "name" VARCHAR(60) NOT NULL
        );

        CREATE TABLE IF NOT EXISTS "appointments" (
        "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "appointment_date" TIMESTAMP NOT NULL,
        "customer_name" VARCHAR(100) NOT NULL,
        "title" VARCHAR(70) NOT NULL,
        "description" TEXT NOT NULL,
        "is_approved" VARCHAR(50) DEFAULT 'PENDING',
        "admin_review" TEXT
        );

        CREATE TABLE IF NOT EXISTS "appointment_files" (
        "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "appointment_id" INT NOT NULL,
        "file_path" VARCHAR(255) NOT NULL
        );

        CREATE TABLE IF NOT EXISTS "supplies" (
        "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "name" VARCHAR(100) NOT NULL,
        "description" TEXT,
        "in_stock" INT NOT NULL
        );

        CREATE TABLE IF NOT EXISTS "orders" (
        "id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "supply_id" INTEGER NOT NULL,
        "provider" VARCHAR(100) NOT NULL,
        "description" text
        );
    `;
  await pool.query(query);
};

const alterTables = async () => {
  const constraints = [
    `ALTER TABLE appointment_files ADD CONSTRAINT fk_appointment_id FOREIGN KEY (appointment_id) REFERENCES appointments(id);`,
    `ALTER TABLE orders ADD CONSTRAINT fk_supply_id FOREIGN KEY (supply_id) REFERENCES supplies(id);`,
    `ALTER TABLE user_roles ADD CONSTRAINT fk_user_id FOREIGN KEY (user_id) REFERENCES users(id);`,
    `ALTER TABLE user_roles ADD CONSTRAINT fk_role_id FOREIGN KEY (role_id) REFERENCES roles(id);`,
  ];

  for (const c of constraints) {
    const safeQuery = `
          DO $$
          BEGIN
            BEGIN
              ${c}
            EXCEPTION WHEN duplicate_object THEN
              RAISE NOTICE 'Constraint already exists: skipping.';
            END;
          END
          $$;
        `;
    await pool.query(safeQuery);
  }
};

const insertRoles = async () => {
  const roles = ["client", "admin"];
  for (const role of roles) {
    try {
      await pool.query(
        "INSERT INTO roles (name) SELECT CAST($1 AS varchar) WHERE NOT EXISTS (SELECT 1 FROM roles WHERE name = $1)",
        [role]
      );
    } catch (err) {
      console.error("error inserting roles: ", err);
    }
  }
};

const setupDatabase = async () => {
  try {
    await createTables();
    await alterTables();
    await insertRoles();
    console.log("database setup complete.");
  } catch (error) {
    console.error("error setting up the database:", error);
  }
};

module.exports = {
  pool,
  setupDatabase,
};
